<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control Center</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: #2d3748;
            line-height: 1.4;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 0;
            border-bottom: none;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 60px;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.40);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
        }

        /* Tab Layout */
        .tab-layout {
            display: flex;
            gap: 0;
            flex: 1;
            min-height: 600px;
            border: 1px solid #ddd;
            background-color: white;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            overflow: hidden;
        }

        /* Vertical Tabs */
        .tabs {
            display: flex;
            flex-direction: column;
            width: 180px;
            border-right: 1px solid #e2e8f0;
            background-color: #f7fafc;
            flex-shrink: 0;
        }

        .tab-button {
            padding: 15px 20px;
            background-color: transparent;
            border: none;
            border-right: 3px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab-button:last-child {
            border-bottom: none;
        }

        .tab-button:hover {
            color: #2d3748;
            background-color: #edf2f7;
        }

        .tab-button.active {
            color: #2196f3;
            border-right-color: #2196f3;
            background-color: white;
            font-weight: 600;
        }

        /* Tab Content Area */
        .tab-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f7fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .header .timestamp {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        /* Section */
        .section {
            background-color: white;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.20);
        }

        .section h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        /* System Summary */
        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 30px;
            align-items: start;
        }

        .summary-right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .summary-item {
            padding: 10px 0;
        }

        .summary-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 28px;
        }

        .pie-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .pie-chart {
            width: 240px !important;
            height: 240px !important;
        }

        /* Alerts */
        .alert-item {
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            background-color: #fafafa;
            font-size: 13px;
            border-radius: 4px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
        }

        .alert-item.critical {
            border-left-color: #dd0000;
            background-color: #fff5f5;
        }

        .alert-item.warning {
            border-left-color: #ff9900;
            background-color: #fffaf0;
        }

        .alert-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            font-weight: bold;
            margin-right: 8px;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            line-height: 20px;
        }

        .alert-item.critical .alert-icon {
            background-color: #dd0000;
        }

        .alert-item.warning .alert-icon {
            background-color: #ff9900;
        }

        .alert-text {
            display: inline;
            vertical-align: middle;
        }

        .alert-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .alert-actions button {
            margin-right: 10px;
            padding: 6px 12px;
            font-size: 12px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            color: #333;
            border-radius: 3px;
        }

        .alert-actions button:hover {
            background-color: #e0e0e0;
        }

        /* Kiosk Status Table */
        .kiosk-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-box, .filter-box {
            padding: 8px 12px;
            border: 1px solid #ddd;
            font-size: 12px;
            border-radius: 3px;
            background-color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box::placeholder {
            color: #aaa;
        }

        .filter-box {
            min-width: 150px;
        }

        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.20);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            font-size: 11px;
        }

        td {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
        }

        tr:nth-child(even) td {
            background-color: #fafafa;
        }

        tr:hover td {
            background-color: #f0f0f0;
        }

        .status-online {
            color: #38a169;
            font-weight: 600;
        }

        .status-offline {
            color: #e53e3e;
            font-weight: 600;
        }

        .status-icon {
            margin-right: 5px;
        }

        .clients-full {
            color: #00aa00;
        }

        .clients-partial {
            color: #ff9900;
        }

        .clients-none {
            color: #dd0000;
        }

        .firmware-mismatch {
            background-color: #fffaf0;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            text-align: right;
            font-size: 11px;
            color: #999;
            margin-top: 20px;
        }

        /* Analytics Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background-color: #fafafa;
            padding: 15px;
            border: 1px solid #eee;
        }

        .metric-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #222;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .metric-detail {
            font-size: 11px;
            color: #999;
        }

        /* Top Users Table */
        .top-users-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .top-users-table {
            background-color: #fafafa;
            padding: 15px;
            border: 1px solid #eee;
        }

        .top-users-table h3 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        .user-item {
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-phone {
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .user-volume {
            color: #222;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        /* Distribution Bar Chart */
        .distribution-item {
            margin-bottom: 12px;
        }

        .distribution-label {
            font-size: 11px;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }

        .distribution-bar {
            height: 20px;
            background-color: #ddd;
            border: 1px solid #ccc;
            position: relative;
            overflow: hidden;
        }

        .distribution-fill {
            height: 100%;
            background-color: #444;
            transition: width 0.3s ease;
        }

        .distribution-percent {
            position: absolute;
            right: 5px;
            top: 2px;
            font-size: 10px;
            color: white;
            font-weight: 500;
        }

        /* Kiosk Comparison Table */
        .comparison-table {
            margin-top: 15px;
        }

        .comparison-table table {
            font-size: 11px;
        }

        .comparison-table td {
            padding: 8px;
        }

        /* Kiosk Management */
        .kiosk-list {
            margin-bottom: 20px;
        }

        .kiosk-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .kiosk-button {
            padding: 10px;
            border: 2px solid #ddd;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .kiosk-button:hover {
            border-color: #999;
            background-color: #fafafa;
        }

        .kiosk-button.active {
            border-color: #222;
            background-color: #f0f0f0;
            font-weight: 600;
        }

        .kiosk-button.offline {
            color: #dd0000;
        }

        .kiosk-button.online {
            color: #00aa00;
        }

        /* Kiosk Details */
        .kiosk-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-panel {
            background-color: #fafafa;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
        }

        .detail-panel h3 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-row {
            padding: 6px 0;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            color: #222;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-badge.online {
            background-color: #f0fff4;
            color: #38a169;
        }

        .status-badge.offline {
            background-color: #fff5f5;
            color: #e53e3e;
        }

        /* Clients List */
        .clients-list {
            margin-top: 10px;
        }

        .client-item {
            padding: 8px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #eee;
            font-size: 11px;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .client-details {
            color: #666;
            font-size: 10px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background-color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: #2d3748;
        }

        .btn:hover {
            background-color: #f7fafc;
            border-color: #cbd5e0;
        }

        .btn.primary {
            background: linear-gradient(135deg, #2196f3 0%, #0078d4 100%);
            color: white;
            border: none;
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #1976d2 0%, #0062b7 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn.danger {
            background-color: #fff5f5;
            color: #e53e3e;
            border-color: #fed7d7;
        }

        .btn.danger:hover {
            background-color: #ffe6e6;
            border-color: #e53e3e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* OTA Status */
        .ota-section {
            background-color: #fafafa;
            padding: 15px;
            border: 1px solid #eee;
            margin-top: 12px;
        }

        .ota-info {
            font-size: 11px;
            margin-bottom: 12px;
        }

        .ota-row {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }

        .ota-row:last-child {
            border-bottom: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }

            .tab-layout {
                min-height: auto;
            }

            .tabs {
                width: 140px;
            }

            .tab-button {
                padding: 12px 15px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .tab-layout {
                flex-direction: column;
            }

            .tabs {
                width: 100%;
                flex-direction: row;
                border-right: none;
                border-bottom: 2px solid #ddd;
                background-color: transparent;
            }

            .tab-button {
                flex: 1;
                text-align: center;
                border-right: none;
                border-bottom: 3px solid transparent;
                border-bottom-color: transparent;
                padding: 12px 10px;
            }

            .tab-button.active {
                border-right: none;
                border-bottom-color: #222;
            }

            .tab-content-area {
                padding: 15px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .summary-value {
                font-size: 20px;
            }

            .kiosk-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .filter-box {
                min-width: 100%;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .top-users-row {
                grid-template-columns: 1fr;
            }

            .kiosk-detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <img src="logo.jpg" alt="Tusafishe Logo" class="logo">
            </div>
            <div class="header-content">
                <h1>Mission Control Center</h1>
                <div class="timestamp" id="timestamp">Last updated: --:--</div>
            </div>
        </div>

        <!-- Tab Layout Container -->
        <div class="tab-layout">
            <!-- Vertical Tabs Sidebar -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab-button" onclick="switchTab('analytics')">Analytics</button>
                <button class="tab-button" onclick="switchTab('kiosks')">Kiosks</button>
                <button class="tab-button" onclick="switchTab('users')">Users</button>
            </div>

            <!-- Tab Content Area -->
            <div class="tab-content-area">

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">

        <!-- System Summary Section -->
        <div class="section">
            <h2>System Summary</h2>
            <div class="summary-grid">
                <div class="summary-item pie-chart-container">
                    <div class="summary-label">Kiosk Status</div>
                    <canvas id="kiosk-status-chart" class="pie-chart"></canvas>
                </div>
                <div class="summary-right-column">
                    <div class="summary-item">
                        <div class="summary-label">Kiosks Online</div>
                        <div class="summary-value" id="kiosks-online">8/10</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Transactions Yesterday</div>
                        <div class="summary-value" id="transactions-yesterday">1,247</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Active Alerts</div>
                        <div class="summary-value" id="active-alerts">2</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Alerts Section -->
        <div class="section">
            <h2>Active Alerts</h2>
            <div id="alerts-container">
                <div class="alert-item critical">
                    <span class="alert-icon">!</span>
                    <span class="alert-text"><strong>CRITICAL:</strong> Kiosk 0002 (School B) - Offline for 45 minutes</span>
                </div>
                <div class="alert-item warning">
                    <span class="alert-icon">!</span>
                    <span class="alert-text"><strong>WARNING:</strong> Kiosk 0005 (School E) - Offline for 8 minutes</span>
                </div>
            </div>
            <div class="alert-actions">
                <button id="dismiss-alerts">Dismiss All</button>
                <a href="#" style="color: #0066cc; text-decoration: none; font-size: 12px;">View All Alerts →</a>
            </div>
        </div>


        <!-- Footer -->
        <div class="footer">
            Dashboard refresh: Every 30 seconds
        </div>

        </div> <!-- End Dashboard Tab -->

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">

        <!-- Daily Volume Chart -->
        <div class="section">
            <h2>Total Water Dispensed Per Day</h2>
            <div style="height: 300px;">
                <canvas id="chart-daily-volume"></canvas>
            </div>
        </div>

        <!-- Daily Transactions Chart -->
        <div class="section">
            <h2>Total Transactions Per Day</h2>
            <div style="height: 300px;">
                <canvas id="chart-daily-transactions"></canvas>
            </div>
        </div>

        <!-- Weekday Analysis Chart -->
        <div class="section">
            <h2>Usage by Day of Week</h2>
            <div style="height: 300px;">
                <canvas id="chart-weekday-trends"></canvas>
            </div>
        </div>

        <!-- Kiosk & Date Selection -->
        <div class="section">
            <h2>Individual Kiosk Analysis</h2>
            <div class="kiosk-controls">
                <select class="filter-box" id="analytics-kiosk-select" style="min-width: 200px;">
                    <option value="">Loading kiosks...</option>
                </select>
                <select class="filter-box" id="analytics-date-select" style="min-width: 200px;" disabled>
                    <option value="">Select a kiosk first (leave empty for all days)</option>
                </select>
                <button class="btn primary" id="btn-load-kiosk-analytics">Load Kiosk Data</button>
            </div>
            <div id="analytics-status" style="font-size: 12px; color: #888; margin-top: 10px;"></div>
        </div>

        <!-- Analytics Metrics -->
        <div class="section">
            <h2>Key Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Transactions</div>
                    <div class="metric-value" id="metric-transactions">--</div>
                    <div class="metric-detail" id="metric-transactions-detail">Unique users: --</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Volume</div>
                    <div class="metric-value" id="metric-avg-volume">-- mL</div>
                    <div class="metric-detail" id="metric-total-volume">Total: --</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-value" id="metric-success-rate">--%</div>
                    <div class="metric-detail" id="metric-pass-fail">Passed: -- / Failed: --</div>
                </div>
            </div>
        </div>

        <!-- Top Users by Volume -->
        <div class="section">
            <h2>Top Users (by Volume)</h2>
            <div style="height: 300px;">
                <canvas id="chart-top-users-volume"></canvas>
            </div>
        </div>

        <!-- Top Users by Frequency -->
        <div class="section">
            <h2>Top Users (by Frequency)</h2>
            <div style="height: 300px;">
                <canvas id="chart-top-users-frequency"></canvas>
            </div>
        </div>

        <!-- Volume Distribution -->
        <div class="section">
            <h2>Volume Distribution</h2>
            <div style="height: 300px; max-width: 600px;">
                <canvas id="chart-volume-distribution"></canvas>
            </div>
        </div>

        <!-- Kiosk Activity -->
        <div class="section">
            <h2>Client Activity</h2>
            <div style="height: 300px;">
                <canvas id="chart-kiosk-activity"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <span id="analytics-footer">Select a CSV file and click "Load Analytics" to view data</span>
        </div>

        </div> <!-- End Analytics Tab -->

        <!-- Kiosk Management Tab -->
        <div id="kiosks" class="tab-content">

        <div class="kiosk-list">
            <div class="section">
                <h2>Kiosk Inventory</h2>
                <div class="kiosk-controls">
                    <input type="text" class="search-box" id="kiosk-search-input" placeholder="Search by Kiosk ID or Location...">
                    <select class="filter-box" id="kiosk-filter-select">
                        <option value="">All Status</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="kiosks-management-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Clients</th>
                                <th>FW Version</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="kiosks-mgmt-tbody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Kiosk Details Section -->
        <div id="kiosk-details" style="display:none;">

        <!-- Quick Info -->
        <div class="section">
            <h2 id="kiosk-title">Kiosk Details</h2>

            <div class="kiosk-detail-grid">
                <!-- Server Status -->
                <div class="detail-panel">
                    <h3>Server Status</h3>
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="detail-value"><span class="status-badge online" id="server-status">● Online</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Seen</span>
                        <span class="detail-value" id="server-last-seen">2 min ago</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Uptime</span>
                        <span class="detail-value" id="server-uptime">45 days</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Heap Usage</span>
                        <span class="detail-value" id="server-heap">65%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">SD Card</span>
                        <span class="detail-value" id="server-sd">42% (1.8 GB)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">MQTT Broker</span>
                        <span class="detail-value" id="server-mqtt">Running (5 conn)</span>
                    </div>
                </div>

                <!-- Firmware Info -->
                <div class="detail-panel">
                    <h3>Firmware</h3>
                    <div class="detail-row">
                        <span class="detail-label">Current Version</span>
                        <span class="detail-value" id="fw-current">v1.0.19d</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Available</span>
                        <span class="detail-value" id="fw-available">v1.0.20a</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Updated</span>
                        <span class="detail-value" id="fw-updated">2025-10-15</span>
                    </div>
                    <div style="margin-top: 12px;">
                        <button class="btn primary" id="btn-ota">Start OTA Update</button>
                        <button class="btn" id="btn-fw-history">View History</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connected Clients -->
        <div class="section">
            <h2>Connected Clients</h2>
            <div class="clients-list" id="clients-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Service Management -->
        <div class="section">
            <h2>Service Management</h2>
            <div class="detail-row" style="padding: 12px 0;">
                <span class="detail-label">Service Status</span>
                <span class="detail-value" id="service-status"><span class="status-badge online">✓ In Service</span></span>
            </div>
            <div class="action-buttons">
                <button class="btn" id="btn-enable">Enable Kiosk</button>
                <button class="btn danger" id="btn-disable">Disable Kiosk</button>
                <button class="btn" id="btn-reboot">Reboot Kiosk</button>
                <button class="btn" id="btn-config">Configuration</button>
                <button class="btn" id="btn-logs">View Logs</button>
            </div>
        </div>

        <!-- Back Button -->
        <div style="margin-top: 20px;">
            <button class="btn" onclick="closeKioskDetail()">← Back to Kiosk List</button>
        </div>

        </div> <!-- End Kiosk Details -->

        </div> <!-- End Kiosk Tab -->

        <!-- Users Tab -->
        <div id="users" class="tab-content">

        <div class="section">
            <h2>Customer Search</h2>
            <div class="kiosk-controls">
                <input type="text" class="search-box" id="user-search-input" placeholder="Search by Phone Number, Name, or Account ID...">
                <select class="filter-box" id="user-status-filter">
                    <option value="">All Customers</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Phone Number</th>
                            <th>Name</th>
                            <th>Account ID</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <button class="btn" id="users-prev-page" onclick="previousUsersPage()" style="padding: 8px 15px; font-size: 12px;">← Previous</button>
                <span id="users-page-info" style="font-size: 12px; color: #666;">Page 1</span>
                <button class="btn" id="users-next-page" onclick="nextUsersPage()" style="padding: 8px 15px; font-size: 12px;">Next →</button>
            </div>
        </div>

        <!-- User Details Section -->
        <div id="user-details" style="display:none;">

        <div class="section">
            <h2 id="user-detail-title">Customer Details</h2>

            <div class="kiosk-detail-grid">
                <!-- User Info -->
                <div class="detail-panel">
                    <h3>Account Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Phone Number</span>
                        <span class="detail-value" id="user-phone">+254700...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value" id="user-name">Name</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Account ID</span>
                        <span class="detail-value" id="user-account-id">AQP123456</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="detail-value"><span class="status-badge online" id="user-status">✓ Active</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Created</span>
                        <span class="detail-value" id="user-created">2025-10-15</span>
                    </div>
                </div>

                <!-- Account Details -->
                <div class="detail-panel">
                    <h3>Account Details</h3>
                    <div class="detail-row">
                        <span class="detail-label">PIN</span>
                        <span class="detail-value" id="user-pin">****</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Registration Complete</span>
                        <span class="detail-value" id="user-registered">✓ Yes</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Service Actions -->
        <div class="section">
            <h2>Customer Service Actions</h2>
            <div class="action-buttons">
                <button class="btn primary" id="btn-reset-pin">Reset PIN</button>
                <button class="btn primary" id="btn-add-credits">Add Credits</button>
                <button class="btn" id="btn-activate">Activate Account</button>
                <button class="btn danger" id="btn-deactivate">Deactivate Account</button>
                <button class="btn" id="btn-view-transactions">View Transactions</button>
                <button class="btn" id="btn-edit-account">Edit Account</button>
            </div>
        </div>

        <!-- Back Button -->
        <div style="margin-top: 20px;">
            <button class="btn" onclick="closeUserDetail()">← Back to Customer List</button>
        </div>

        </div> <!-- End User Details -->

        </div> <!-- End Users Tab -->

            </div> <!-- End Tab Content Area -->
        </div> <!-- End Tab Layout -->

    </div>

    <script>
        // Sample data
        // Appwrite Configuration
        const PROXY_ENDPOINT = 'https://first-many-snake.ngrok-free.app';
        const DATABASE_ID = '6864aed388d20c69a461';
        const CUSTOMERS_COLLECTION_ID = 'customers';

        // Users pagination state
        let allUsers = [];
        let currentUsersPage = 1;
        const USERS_PER_PAGE = 10;

        // Fetch all users from Appwrite via proxy with pagination support
        async function fetchAllUsers() {
            try {
                const allDocuments = [];
                let offset = 0;
                const limit = 25; // Appwrite's hard limit
                let total = null;

                // Keep fetching until we have all documents
                while (true) {
                    const url = `${PROXY_ENDPOINT}/v1/databases/${DATABASE_ID}/collections/${CUSTOMERS_COLLECTION_ID}/documents?limit=${limit}&offset=${offset}`;

                    console.log('Fetching users from proxy:', url);

                    const response = await fetch(url, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Store total on first request
                    if (total === null) {
                        total = data.total || 0;
                        console.log(`Total users in database: ${total}`);
                    }

                    // Add these documents to our collection
                    const docsInThisBatch = data.documents || [];
                    console.log(`Batch at offset ${offset}: received ${docsInThisBatch.length} documents`);
                    allDocuments.push(...docsInThisBatch);

                    // Check if we've fetched all documents
                    if (allDocuments.length >= total || docsInThisBatch.length === 0) {
                        break;
                    }

                    // Move to next page
                    offset += limit;
                }

                console.log(`Fetched ${allDocuments.length} total users`);
                return allDocuments;
            } catch (error) {
                console.error('Error fetching users:', error);
                throw error;
            }
        }

        // Convert Appwrite customer data to display format
        function formatUserForDisplay(customer) {
            return {
                phone: customer.phone_number,
                name: customer.full_name || 'Unknown',
                account_id: customer.account_id || 'N/A',
                status: customer.active ? 'active' : 'inactive',
                created: formatDate(customer.created_at),
                // Store original data for detail view
                _original: customer
            };
        }

        // Format ISO timestamp to readable date
        function formatDate(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            return date.toLocaleDateString();
        }

        const sampleData = {
            summary: {
                kiosks_online: 8,
                kiosks_offline: 2,
                kiosks_total: 10,
                transactions_yesterday: 1247,
                active_alerts: 2
            },
            kiosks: [
                { id: '0001', location: 'School A', status: 'online', connected_clients: 5, total_clients: 5, firmware: 'v1.0.19d', last_seen: '2 min ago' },
                { id: '0002', location: 'School B', status: 'offline', connected_clients: 0, total_clients: 5, firmware: 'v1.0.19d', last_seen: '45 min ago' },
                { id: '0003', location: 'School C', status: 'online', connected_clients: 3, total_clients: 5, firmware: 'v1.0.19a', last_seen: '1 min ago' },
                { id: '0004', location: 'School D', status: 'online', connected_clients: 4, total_clients: 5, firmware: 'v1.0.19d', last_seen: '3 min ago' },
                { id: '0005', location: 'School E', status: 'offline', connected_clients: 1, total_clients: 5, firmware: 'v1.0.19d', last_seen: '8 min ago' },
                { id: '0006', location: 'School F', status: 'online', connected_clients: 5, total_clients: 5, firmware: 'v1.0.19d', last_seen: '1 min ago' },
                { id: '0007', location: 'School G', status: 'online', connected_clients: 4, total_clients: 5, firmware: 'v1.0.19d', last_seen: '2 min ago' },
                { id: '0008', location: 'School H', status: 'online', connected_clients: 5, total_clients: 5, firmware: 'v1.0.19d', last_seen: '1 min ago' },
                { id: '0009', location: 'School I', status: 'online', connected_clients: 3, total_clients: 5, firmware: 'v1.0.19d', last_seen: '2 min ago' },
                { id: '0010', location: 'School J', status: 'online', connected_clients: 5, total_clients: 5, firmware: 'v1.0.19d', last_seen: '1 min ago' }
            ],
            kioskDetails: {
                '0001': {
                    location: 'School A',
                    status: 'online',
                    last_seen: '2 min ago',
                    uptime_days: 45,
                    heap_percent: 65,
                    sd_card_percent: 42,
                    mqtt_clients: 5,
                    firmware_current: 'v1.0.19d',
                    firmware_available: 'v1.0.20a',
                    firmware_updated: '2025-10-15',
                    service_status: 'in_service',
                    clients: [
                        { id: 1, name: 'dispenser_1', rssi: -45, firmware: 'v1.0.19d', status: 'online' },
                        { id: 2, name: 'dispenser_2', rssi: -52, firmware: 'v1.0.19d', status: 'online' },
                        { id: 3, name: 'dispenser_3', rssi: -48, firmware: 'v1.0.19d', status: 'online' },
                        { id: 4, name: 'dispenser_4', rssi: -56, firmware: 'v1.0.19d', status: 'online' },
                        { id: 5, name: 'dispenser_5', rssi: -61, firmware: 'v1.0.19d', status: 'online' }
                    ]
                }
            },
            users: [
                { phone: '+254700001234', name: 'Jane Smith', account_id: 'AQP123456', status: 'active', credits: 5000, created: '2025-10-15', last_activity: '2 hours ago' },
                { phone: '+254700005678', name: 'John Doe', account_id: 'AQP123457', status: 'active', credits: 2500, created: '2025-10-20', last_activity: '1 day ago' },
                { phone: '+254700002468', name: 'Mary Johnson', account_id: 'AQP123458', status: 'active', credits: 8200, created: '2025-09-15', last_activity: '30 min ago' },
                { phone: '+254700009876', name: 'Peter Brown', account_id: 'AQP123459', status: 'inactive', credits: 0, created: '2025-08-10', last_activity: '5 days ago' },
                { phone: '+254700003210', name: 'Sarah Wilson', account_id: 'AQP123460', status: 'active', credits: 3750, created: '2025-10-01', last_activity: '2 hours ago' }
            ]
        };

        // Update summary metrics
        function updateSummary(data) {
            document.getElementById('kiosks-online').textContent = `${data.summary.kiosks_online}/${data.summary.kiosks_total}`;
            document.getElementById('transactions-yesterday').textContent = data.summary.transactions_yesterday.toLocaleString();
            document.getElementById('active-alerts').textContent = data.summary.active_alerts;
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('timestamp').textContent = `Last updated: ${hours}:${minutes}`;
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Deactivate all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Activate selected button
            event.target.classList.add('active');

            // Return to tab home page based on selected tab
            switch(tabName) {
                case 'dashboard':
                    // Dashboard shows main view by default, no action needed
                    break;
                case 'analytics':
                    // Load daily trends automatically when entering analytics tab
                    loadDailyTrends();
                    break;
                case 'kiosks':
                    // Return to kiosk list when entering kiosks tab
                    closeKioskDetail();
                    break;
                case 'users':
                    // Return to user list when entering users tab
                    closeUserDetail();
                    break;
            }
        }

        // Render kiosk management table
        function renderKioskMgmtTable(kiosks) {
            const tbody = document.getElementById('kiosks-mgmt-tbody');
            tbody.innerHTML = '';

            kiosks.forEach(kiosk => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => selectKiosk(kiosk.id);

                const statusClass = kiosk.status === 'online' ? 'status-online' : 'status-offline';
                const statusIcon = kiosk.status === 'online' ? '✓' : '✗';

                let clientsClass = 'clients-none';
                if (kiosk.connected_clients === kiosk.total_clients) {
                    clientsClass = 'clients-full';
                } else if (kiosk.connected_clients > 0) {
                    clientsClass = 'clients-partial';
                }

                const fwMismatchClass = kiosk.firmware !== 'v1.0.19d' ? 'firmware-mismatch' : '';

                row.innerHTML = `
                    <td>${kiosk.id}</td>
                    <td>${kiosk.location}</td>
                    <td><span class="${statusClass}"><span class="status-icon">${statusIcon}</span>${kiosk.status.charAt(0).toUpperCase() + kiosk.status.slice(1)}</span></td>
                    <td><span class="${clientsClass}">${kiosk.connected_clients}/${kiosk.total_clients}</span></td>
                    <td class="${fwMismatchClass}">${kiosk.firmware}</td>
                    <td>${kiosk.last_seen}</td>
                    <td><button class="btn" onclick="event.stopPropagation(); selectKiosk('${kiosk.id}');">Manage</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter and search kiosks in management table
        function filterKioskMgmt() {
            const searchTerm = document.getElementById('kiosk-search-input').value.toLowerCase();
            const filterStatus = document.getElementById('kiosk-filter-select').value;

            const filtered = sampleData.kiosks.filter(kiosk => {
                const matchesSearch = kiosk.id.includes(searchTerm) || kiosk.location.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === '' || kiosk.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            renderKioskMgmtTable(filtered);
        }

        // Select and display kiosk details
        function selectKiosk(kioskId) {
            // Get kiosk data
            const kiosk = sampleData.kiosks.find(k => k.id === kioskId);
            const details = sampleData.kioskDetails[kioskId] || sampleData.kioskDetails['0001'];

            // Update detail panel
            document.getElementById('kiosk-title').textContent = `Kiosk ${kioskId} - ${details.location}`;
            document.getElementById('server-status').textContent = `● ${kiosk.status.charAt(0).toUpperCase() + kiosk.status.slice(1)}`;
            document.getElementById('server-status').className = `status-badge ${kiosk.status}`;
            document.getElementById('server-last-seen').textContent = kiosk.last_seen;
            document.getElementById('server-uptime').textContent = `${details.uptime_days} days`;
            document.getElementById('server-heap').textContent = `${details.heap_percent}%`;
            document.getElementById('server-sd').textContent = `${details.sd_card_percent}% (1.8 GB)`;
            document.getElementById('server-mqtt').textContent = `Running (${details.mqtt_clients} conn)`;
            document.getElementById('fw-current').textContent = details.firmware_current;
            document.getElementById('fw-available').textContent = details.firmware_available;
            document.getElementById('fw-updated').textContent = details.firmware_updated;

            // Update service status
            const serviceStatusText = details.service_status === 'in_service' ? '✓ In Service' : '✗ Out of Service';
            const serviceStatusClass = details.service_status === 'in_service' ? 'online' : 'offline';
            document.getElementById('service-status').innerHTML = `<span class="status-badge ${serviceStatusClass}">${serviceStatusText}</span>`;

            // Render connected clients
            renderClients(details.clients);

            // Show details, hide list
            document.getElementById('kiosk-details').style.display = 'block';
            document.querySelector('.kiosk-list').style.display = 'none';
        }

        // Render connected clients
        function renderClients(clients) {
            const clientsList = document.getElementById('clients-list');
            clientsList.innerHTML = '';

            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'client-item';
                const statusClass = client.status === 'online' ? 'online' : 'offline';
                const statusText = client.status === 'online' ? '✓' : '✗';
                item.innerHTML = `
                    <div class="client-header">
                        <span><strong>Client ${client.id}: ${client.name}</strong> <span class="status-badge ${statusClass}">${statusText} ${client.status}</span></span>
                    </div>
                    <div class="client-details">
                        RSSI: ${client.rssi} dBm | Firmware: ${client.firmware}
                    </div>
                `;
                clientsList.appendChild(item);
            });
        }

        // Close kiosk detail view
        function closeKioskDetail() {
            document.getElementById('kiosk-details').style.display = 'none';
            document.querySelector('.kiosk-list').style.display = 'block';
            document.querySelectorAll('.kiosk-button').forEach(btn => btn.classList.remove('active'));
        }

        // Render users table with pagination
        function renderUsersTable(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';

            // Calculate pagination
            const totalPages = Math.ceil(users.length / USERS_PER_PAGE);
            const startIndex = (currentUsersPage - 1) * USERS_PER_PAGE;
            const endIndex = startIndex + USERS_PER_PAGE;
            const pageUsers = users.slice(startIndex, endIndex);

            // Update page info
            document.getElementById('users-page-info').textContent = `Page ${currentUsersPage} of ${totalPages || 1}`;
            document.getElementById('users-prev-page').disabled = currentUsersPage === 1;
            document.getElementById('users-next-page').disabled = currentUsersPage >= totalPages || totalPages === 0;

            // Render rows
            pageUsers.forEach(user => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => selectUser(user.phone);

                const statusClass = user.status === 'active' ? 'status-online' : 'status-offline';
                const statusText = user.status === 'active' ? '✓ Active' : '✗ Inactive';

                row.innerHTML = `
                    <td>${user.phone}</td>
                    <td>${user.name}</td>
                    <td>${user.account_id}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${user.created}</td>
                    <td><button class="btn" onclick="event.stopPropagation(); selectUser('${user.phone}');">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Pagination functions
        function previousUsersPage() {
            if (currentUsersPage > 1) {
                currentUsersPage--;
                displayCurrentUsersPage();
            }
        }

        function nextUsersPage() {
            const totalPages = Math.ceil(allUsers.length / USERS_PER_PAGE);
            if (currentUsersPage < totalPages) {
                currentUsersPage++;
                displayCurrentUsersPage();
            }
        }

        function displayCurrentUsersPage() {
            const filtered = filterUsersData(allUsers);
            renderUsersTable(filtered);
        }

        // Convert wildcard pattern to regex
        function wildcardToRegex(pattern) {
            // Escape special regex characters except *
            const escaped = pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
            // Replace * with regex wildcard .*
            const regex = escaped.replace(/\*/g, '.*');
            return new RegExp(`^${regex}$`, 'i'); // Case-insensitive, full match
        }

        // Filter users data based on search and status
        function filterUsersData(users) {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            const statusFilter = document.getElementById('user-status-filter').value;

            const filtered = users.filter(user => {
                // Defensive checks for undefined fields
                const phone = (user.phone || '').toString().toLowerCase();

                let matchesSearch = !searchTerm; // Empty search matches all

                if (searchTerm) {
                    // Create regex pattern from wildcard search term
                    const pattern = wildcardToRegex(searchTerm);

                    // Check if phone number matches the wildcard pattern
                    matchesSearch = pattern.test(phone);
                }

                const matchesFilter = statusFilter === '' || user.status === statusFilter;
                return matchesSearch && matchesFilter;
            });

            return filtered;
        }

        // Filter and search users
        function filterUsers() {
            currentUsersPage = 1; // Reset to page 1 when searching
            const filtered = filterUsersData(allUsers);
            renderUsersTable(filtered);
        }

        // Select and display user details
        function selectUser(phone) {
            const user = allUsers.find(u => u.phone === phone);
            if (!user) {
                console.error('User not found:', phone);
                return;
            }

            // Get original Appwrite data if available, otherwise use formatted data
            const originalData = user._original || user;

            document.getElementById('user-detail-title').textContent = `Customer: ${user.name || 'Unknown'}`;
            document.getElementById('user-phone').textContent = user.phone || 'Unknown';
            document.getElementById('user-name').textContent = user.name || 'Unknown';
            document.getElementById('user-account-id').textContent = user.account_id || 'N/A';

            const statusBadge = document.getElementById('user-status');
            if (user.status === 'active') {
                statusBadge.textContent = '✓ Active';
                statusBadge.className = 'status-badge online';
            } else {
                statusBadge.textContent = '✗ Inactive';
                statusBadge.className = 'status-badge offline';
            }

            document.getElementById('user-created').textContent = user.created;

            // Set registration status
            const registeredBadge = document.getElementById('user-registered');
            if (originalData.is_registered) {
                registeredBadge.textContent = '✓ Yes';
            } else {
                registeredBadge.textContent = '✗ No';
            }

            // Display PIN (masked)
            document.getElementById('user-pin').textContent = originalData.pin ? '••••' : 'Not set';

            // Show details, hide list
            document.getElementById('user-details').style.display = 'block';
            document.querySelector('#users .section').style.display = 'none';
        }

        // Close user detail view
        function closeUserDetail() {
            document.getElementById('user-details').style.display = 'none';
            document.querySelector('#users .section').style.display = 'block';
        }

        // Render kiosk status pie chart
        let kioskChartInstance = null;
        function renderKioskStatusChart(data) {
            const ctx = document.getElementById('kiosk-status-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (kioskChartInstance) {
                kioskChartInstance.destroy();
            }

            kioskChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Online', 'Offline'],
                    datasets: [{
                        data: [data.summary.kiosks_online, data.summary.kiosks_offline],
                        backgroundColor: ['#3b82f6', '#1e40af'],
                        borderColor: ['#2563eb', '#1e3a8a'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                padding: 10
                            }
                        }
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            updateSummary(sampleData);
            renderKioskStatusChart(sampleData);
            renderKioskMgmtTable(sampleData.kiosks);

            // Add event listeners for Dashboard tab
            document.getElementById('dismiss-alerts').addEventListener('click', function() {
                alert('Alerts dismissed. (This is a mock action)');
            });

            // Add event listeners for Kiosk Management tab
            document.getElementById('kiosk-search-input').addEventListener('input', filterKioskMgmt);
            document.getElementById('kiosk-filter-select').addEventListener('change', filterKioskMgmt);

            // Add event listeners for Users tab
            document.getElementById('user-search-input').addEventListener('input', filterUsers);
            document.getElementById('user-status-filter').addEventListener('change', filterUsers);

            // Load users from Appwrite
            fetchAllUsers()
                .then(appwriteUsers => {
                    // Convert Appwrite data to display format
                    allUsers = appwriteUsers.map(formatUserForDisplay);
                    console.log(`Loaded ${allUsers.length} users from Appwrite`);
                    renderUsersTable(allUsers);
                })
                .catch(error => {
                    console.error('Failed to load users:', error);
                    const tbody = document.getElementById('users-tbody');
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #f00;">Error loading users from database. Check browser console for details.</td></tr>`;
                });

            // User detail button actions
            document.getElementById('btn-reset-pin').addEventListener('click', function() {
                alert('Reset PIN - Generate new PIN for this customer. (Mock action)');
            });
            document.getElementById('btn-add-credits').addEventListener('click', function() {
                alert('Add Credits - Increase customer credit balance. (Mock action)');
            });
            document.getElementById('btn-activate').addEventListener('click', function() {
                alert('Account Activated. (Mock action)');
            });
            document.getElementById('btn-deactivate').addEventListener('click', function() {
                if (confirm('Are you sure you want to deactivate this account?')) {
                    alert('Account Deactivated. (Mock action)');
                }
            });
            document.getElementById('btn-view-transactions').addEventListener('click', function() {
                alert('Showing transaction history. (Mock action)');
            });
            document.getElementById('btn-edit-account').addEventListener('click', function() {
                alert('Edit account information. (Mock action)');
            });

            // Kiosk tab button actions
            document.getElementById('btn-ota').addEventListener('click', function() {
                alert('OTA Update started. (Mock action)');
            });
            document.getElementById('btn-fw-history').addEventListener('click', function() {
                alert('Showing firmware history. (Mock action)');
            });
            document.getElementById('btn-enable').addEventListener('click', function() {
                alert('Kiosk enabled. (Mock action)');
            });
            document.getElementById('btn-disable').addEventListener('click', function() {
                if (confirm('Are you sure you want to disable this kiosk?')) {
                    alert('Kiosk disabled. (Mock action)');
                }
            });
            document.getElementById('btn-reboot').addEventListener('click', function() {
                if (confirm('Are you sure you want to reboot this kiosk?')) {
                    alert('Reboot initiated. (Mock action)');
                }
            });
            document.getElementById('btn-config').addEventListener('click', function() {
                alert('Configuration interface. (Mock action)');
            });
            document.getElementById('btn-logs').addEventListener('click', function() {
                alert('Downloading logs. (Mock action)');
            });

            // Update timestamp every minute
            setInterval(updateTimestamp, 60000);

            // Analytics tab initialization
            loadAvailableKiosks();
            loadDailyTrends();  // Load daily trends on page load
            document.getElementById('analytics-kiosk-select').addEventListener('change', (e) => {
                loadAvailableDates(e.target.value);
            });
            document.getElementById('btn-load-kiosk-analytics').addEventListener('click', loadKioskAnalyticsData);
        });

        // Analytics Functions
        let chartInstances = {};
        const ANALYTICS_API = 'http://localhost:8082';

        function loadAvailableKiosks() {
            fetch(`${ANALYTICS_API}/api/analytics/kiosks`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('analytics-kiosk-select');
                    select.innerHTML = '';

                    if (!data.kiosks || data.kiosks.length === 0) {
                        select.innerHTML = '<option value="">No kiosks found</option>';
                        document.getElementById('analytics-status').textContent = 'No kiosks found';
                        return;
                    }

                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Select a kiosk...';
                    select.appendChild(option);

                    data.kiosks.forEach(kiosk => {
                        const opt = document.createElement('option');
                        opt.value = kiosk.id;
                        opt.textContent = `${kiosk.name} (${kiosk.id})`;
                        select.appendChild(opt);
                    });

                    document.getElementById('analytics-status').textContent = `Found ${data.kiosks.length} kiosk(s)`;
                })
                .catch(error => {
                    console.error('Error loading kiosks:', error);
                    document.getElementById('analytics-status').textContent = 'Error loading kiosks';
                });
        }

        function loadAvailableDates(kioskId) {
            if (!kioskId) {
                document.getElementById('analytics-date-select').disabled = true;
                document.getElementById('analytics-date-select').innerHTML = '<option value="">Select a kiosk first</option>';
                return;
            }

            fetch(`${ANALYTICS_API}/api/analytics/kiosk/${kioskId}/dates`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('analytics-date-select');
                    select.innerHTML = '';
                    select.disabled = false;

                    if (!data.dates || data.dates.length === 0) {
                        select.innerHTML = '<option value="">No dates found</option>';
                        select.disabled = true;
                        return;
                    }

                    // Add "Select a date..." option
                    const selectOption = document.createElement('option');
                    selectOption.value = '';
                    selectOption.textContent = 'Select a date...';
                    select.appendChild(selectOption);

                    // Add "All dates" option
                    const allDatesOption = document.createElement('option');
                    allDatesOption.value = 'all';
                    allDatesOption.textContent = 'All dates';
                    select.appendChild(allDatesOption);

                    // Add individual dates
                    data.dates.forEach(date => {
                        const opt = document.createElement('option');
                        opt.value = date;
                        opt.textContent = date;
                        select.appendChild(opt);
                    });

                    document.getElementById('analytics-status').textContent = `Found ${data.dates.length} date(s) for kiosk ${kioskId}`;
                })
                .catch(error => {
                    console.error('Error loading dates:', error);
                    document.getElementById('analytics-status').textContent = 'Error loading dates';
                    document.getElementById('analytics-date-select').disabled = true;
                });
        }

        function loadKioskAnalyticsData() {
            const kioskId = document.getElementById('analytics-kiosk-select').value;
            const selectedDate = document.getElementById('analytics-date-select').value;

            if (!kioskId) {
                alert('Please select a kiosk');
                return;
            }

            // If no date is selected (empty string), clear the analytics section
            if (!selectedDate || selectedDate === '') {
                clearAnalyticsCharts();
                document.getElementById('analytics-status').textContent = 'Please select a date or "All dates"';
                return;
            }

            // Determine if loading all dates or a single day
            const isSingleDay = selectedDate !== 'all';

            document.getElementById('analytics-status').textContent = 'Loading kiosk data...';
            document.getElementById('btn-load-kiosk-analytics').disabled = true;

            let url = `${ANALYTICS_API}/api/analytics/kiosk/${kioskId}`;
            if (isSingleDay) {
                url += `?date=${selectedDate}`;
            } else {
                url += `?date=all`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateKioskMetrics(data.summary);

                    if (isSingleDay) {
                        createTopUsersByVolumeChartFromTransactions(data.transactions);
                        createTopUsersByFrequencyChartFromTransactions(data.transactions);
                        createVolumeDistributionChartFromTransactions(data.transactions);
                        createClientActivityChartFromTransactions(data.transactions);
                    } else {
                        createTopUsersByVolumeChartFromDaily(data.daily);
                        createTopUsersByFrequencyChartFromDaily(data.daily);
                        createVolumeDistributionChartFromDaily(data.daily);
                        createClientActivityChartFromDaily(data.daily);
                    }

                    const dateDisplay = isSingleDay ? `${selectedDate}` : 'average daily data';
                    document.getElementById('analytics-status').textContent = `Loaded ${dateDisplay} for kiosk ${kioskId}`;
                    document.getElementById('analytics-footer').textContent = `Displaying ${dateDisplay} for kiosk ${kioskId}`;
                    document.getElementById('btn-load-kiosk-analytics').disabled = false;
                })
                .catch(error => {
                    console.error('Error loading kiosk analytics:', error);
                    document.getElementById('analytics-status').textContent = 'Error loading kiosk data';
                    document.getElementById('btn-load-kiosk-analytics').disabled = false;
                });
        }

        function clearAnalyticsCharts() {
            // Clear metrics
            document.getElementById('metric-transactions').textContent = '--';
            document.getElementById('metric-transactions-detail').textContent = 'Unique users: --';
            document.getElementById('metric-avg-volume').textContent = '-- mL';
            document.getElementById('metric-total-volume').textContent = 'Total: --';
            document.getElementById('metric-success-rate').textContent = '--%';
            document.getElementById('metric-pass-fail').textContent = 'Passed: -- / Failed: --';

            // Destroy all chart instances
            if (chartInstances.volumeChart) {
                chartInstances.volumeChart.destroy();
                chartInstances.volumeChart = null;
            }
            if (chartInstances.frequencyChart) {
                chartInstances.frequencyChart.destroy();
                chartInstances.frequencyChart = null;
            }
            if (chartInstances.distributionChart) {
                chartInstances.distributionChart.destroy();
                chartInstances.distributionChart = null;
            }
            if (chartInstances.clientActivityChart) {
                chartInstances.clientActivityChart.destroy();
                chartInstances.clientActivityChart = null;
            }

            document.getElementById('analytics-footer').textContent = 'Select a date or "All dates" and click "Load Kiosk Data"';
        }

        function updateMetrics(summary) {
            document.getElementById('metric-transactions').textContent = summary.total_transactions.toLocaleString();
            document.getElementById('metric-transactions-detail').textContent = `Unique users: ${summary.unique_users}`;
            document.getElementById('metric-avg-volume').textContent = Math.round(summary.average_volume / 1000) + ' L';
            document.getElementById('metric-total-volume').textContent = `Total: ${(summary.total_volume / 1000).toFixed(1)} L`;
            document.getElementById('metric-success-rate').textContent = summary.success_rate.toFixed(1) + '%';
            document.getElementById('metric-pass-fail').textContent = `Passed: ${summary.pass_count} / Failed: ${summary.fail_count}`;
        }

        function updateKioskMetrics(summary) {
            // Check if this is average data or single day data
            const isAverage = summary.is_average || false;
            const prefix = isAverage ? 'Avg: ' : '';
            const suffix = isAverage ? '/day' : '';

            // Display transactions
            const transactionsValue = isAverage ? Math.round(summary.total_transactions) : summary.total_transactions;
            document.getElementById('metric-transactions').textContent = transactionsValue.toLocaleString() + (isAverage ? '/day' : '');

            // Detail line shows unique users and number of days if average
            let detailText = `Unique users: ${summary.unique_users}`;
            if (isAverage && summary.num_days) {
                detailText += ` (${summary.num_days} days)`;
            }
            document.getElementById('metric-transactions-detail').textContent = detailText;

            // Calculate average volume per transaction
            const avgVolume = summary.total_transactions > 0 ? summary.total_volume_ml / summary.total_transactions : 0;
            document.getElementById('metric-avg-volume').textContent = (avgVolume / 1000).toFixed(2) + ' L';

            // Total volume label changes based on whether it's average
            const volumeLabel = isAverage ? 'Avg/day: ' : 'Total: ';
            document.getElementById('metric-total-volume').textContent = volumeLabel + (summary.total_volume_ml / 1000).toFixed(1) + ' L';

            // Success rate
            const successRate = summary.total_transactions > 0 ? (summary.pass_count / summary.total_transactions * 100) : 0;
            document.getElementById('metric-success-rate').textContent = successRate.toFixed(1) + '%';

            // Pass/Fail counts
            const passCount = isAverage ? Math.round(summary.pass_count) : summary.pass_count;
            const failCount = isAverage ? Math.round(summary.fail_count) : summary.fail_count;
            const passFailSuffix = isAverage ? '/day' : '';
            document.getElementById('metric-pass-fail').textContent = `Passed: ${passCount} / Failed: ${failCount}${passFailSuffix}`;
        }

        function createTopUsersByVolumeChartFromTransactions(transactions) {
            // Aggregate volume by user_id from transactions
            const userVolumes = {};
            transactions.forEach(t => {
                if (!userVolumes[t.user_id]) {
                    userVolumes[t.user_id] = 0;
                }
                userVolumes[t.user_id] += t.volume_ml;
            });

            // Sort and get top 20
            const sorted = Object.entries(userVolumes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            const labels = sorted.map(d => d[0]);
            const data = sorted.map(d => d[1]);

            createTopUsersByVolumeChart({ labels, data });
        }

        function createTopUsersByFrequencyChartFromTransactions(transactions) {
            // Count transactions by user_id
            const userCounts = {};
            transactions.forEach(t => {
                if (!userCounts[t.user_id]) {
                    userCounts[t.user_id] = 0;
                }
                userCounts[t.user_id]++;
            });

            // Sort and get top 20
            const sorted = Object.entries(userCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            const labels = sorted.map(d => d[0]);
            const data = sorted.map(d => d[1]);

            createTopUsersByFrequencyChart({ labels, data });
        }

        function createClientActivityChartFromTransactions(transactions) {
            // Count transactions by client
            const clientCounts = {};
            transactions.forEach(t => {
                if (!clientCounts[t.client]) {
                    clientCounts[t.client] = 0;
                }
                clientCounts[t.client]++;
            });

            const labels = Object.keys(clientCounts);
            const data = Object.values(clientCounts);

            createKioskActivityChart({ labels, data });
        }

        function createTopUsersByVolumeChartFromDaily(dailyData) {
            // Aggregate volume from all daily records
            const userVolumes = {};
            dailyData.forEach(day => {
                const dayUserVolumes = day.user_volumes || {};
                Object.entries(dayUserVolumes).forEach(([userId, volume]) => {
                    if (!userVolumes[userId]) {
                        userVolumes[userId] = 0;
                    }
                    userVolumes[userId] += volume;
                });
            });

            // Calculate averages by dividing by number of days
            const numDays = dailyData.length;
            Object.keys(userVolumes).forEach(userId => {
                userVolumes[userId] = userVolumes[userId] / numDays;
            });

            // Sort and get top 20
            const sorted = Object.entries(userVolumes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            const labels = sorted.map(d => d[0]);
            const data = sorted.map(d => d[1]);

            createTopUsersByVolumeChart({ labels, data });
        }

        function createTopUsersByFrequencyChartFromDaily(dailyData) {
            // Count transactions from all daily records
            const userCounts = {};
            dailyData.forEach(day => {
                const dayUserCounts = day.user_access_count || {};
                Object.entries(dayUserCounts).forEach(([userId, count]) => {
                    if (!userCounts[userId]) {
                        userCounts[userId] = 0;
                    }
                    userCounts[userId] += count;
                });
            });

            // Calculate averages by dividing by number of days
            const numDays = dailyData.length;
            Object.keys(userCounts).forEach(userId => {
                userCounts[userId] = userCounts[userId] / numDays;
            });

            // Sort and get top 20
            const sorted = Object.entries(userCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            const labels = sorted.map(d => d[0]);
            const data = sorted.map(d => d[1]);

            createTopUsersByFrequencyChart({ labels, data });
        }

        function createVolumeDistributionChartFromTransactions(transactions) {
            // Create volume distribution histogram
            const volumes = transactions.map(t => t.volume_ml);

            // Define bucket ranges (0-200, 200-400, 400-600, etc.)
            const buckets = {};
            const bucketSize = 100;
            volumes.forEach(volume => {
                const bucketIndex = Math.floor(volume / bucketSize);
                const bucketLabel = `${bucketIndex * bucketSize}-${(bucketIndex + 1) * bucketSize}`;
                buckets[bucketLabel] = (buckets[bucketLabel] || 0) + 1;
            });

            const sortedBuckets = Object.entries(buckets).sort((a, b) => {
                return parseInt(a[0]) - parseInt(b[0]);
            });

            // Convert to object format expected by createVolumeDistributionChart
            const distributionData = {};
            sortedBuckets.forEach(([label, count]) => {
                distributionData[label] = count;
            });

            createVolumeDistributionChart(distributionData);
        }

        function createVolumeDistributionChartFromDaily(dailyData) {
            // Collect all individual volumes from daily data
            const allVolumes = [];
            dailyData.forEach(day => {
                const dayVolumes = day.individual_volumes || [];
                allVolumes.push(...dayVolumes);
            });

            // Create volume distribution histogram
            const buckets = {};
            const bucketSize = 100;
            allVolumes.forEach(volume => {
                const bucketIndex = Math.floor(volume / bucketSize);
                const bucketLabel = `${bucketIndex * bucketSize}-${(bucketIndex + 1) * bucketSize}`;
                buckets[bucketLabel] = (buckets[bucketLabel] || 0) + 1;
            });

            // Calculate averages by dividing by number of days
            const numDays = dailyData.length;
            Object.keys(buckets).forEach(label => {
                buckets[label] = buckets[label] / numDays;
            });

            const sortedBuckets = Object.entries(buckets).sort((a, b) => {
                return parseInt(a[0]) - parseInt(b[0]);
            });

            // Convert to object format expected by createVolumeDistributionChart
            const distributionData = {};
            sortedBuckets.forEach(([label, count]) => {
                distributionData[label] = count;
            });

            createVolumeDistributionChart(distributionData);
        }

        function createClientActivityChartFromDaily(dailyData) {
            // For daily data, we'll show average transaction counts per day
            // This shows the daily breakdown which is already in the right format
            const ctx = document.getElementById('chart-kiosk-activity').getContext('2d');

            if (chartInstances.clientActivityChart) {
                chartInstances.clientActivityChart.destroy();
            }

            const labels = dailyData.map(d => d.date);
            const data = dailyData.map(d => d.transactions);

            chartInstances.clientActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.slice(-10),  // Show last 10 days
                    datasets: [{
                        label: 'Daily Transaction Count',
                        data: data.slice(-10),
                        backgroundColor: '#2196f3',
                        borderColor: '#1976d2',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function createTopUsersByVolumeChart(data) {
            const ctx = document.getElementById('chart-top-users-volume').getContext('2d');

            if (chartInstances.volumeChart) {
                chartInstances.volumeChart.destroy();
            }

            chartInstances.volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels.slice(0, 20),
                    datasets: [{
                        label: 'Volume (L)',
                        data: data.data.slice(0, 20),
                        backgroundColor: '#2196f3',
                        borderColor: '#1976d2',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.x;
                                    return 'Volume: ' + (value / 1000).toFixed(2) + ' L';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return (value / 1000).toFixed(1) + ' L';
                                }
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 9 } }
                        }
                    }
                }
            });
        }

        function createTopUsersByFrequencyChart(data) {
            const ctx = document.getElementById('chart-top-users-frequency').getContext('2d');

            if (chartInstances.frequencyChart) {
                chartInstances.frequencyChart.destroy();
            }

            chartInstances.frequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels.slice(0, 20),
                    datasets: [{
                        label: 'Access Count',
                        data: data.data.slice(0, 20),
                        backgroundColor: '#2196f3',
                        borderColor: '#1976d2',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 9 } }
                        }
                    }
                }
            });
        }

        function createVolumeDistributionChart(data) {
            const ctx = document.getElementById('chart-volume-distribution').getContext('2d');

            if (chartInstances.distributionChart) {
                chartInstances.distributionChart.destroy();
            }

            const labels = Object.keys(data);
            const values = Object.values(data);

            chartInstances.distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Transaction Count',
                        data: values,
                        backgroundColor: '#2196f3',
                        borderColor: '#1976d2',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Volume (mL)',
                                font: { size: 11, weight: '600' },
                                color: '#666'
                            }
                        }
                    }
                }
            });
        }

        function createKioskActivityChart(data) {
            const ctx = document.getElementById('chart-kiosk-activity').getContext('2d');

            if (chartInstances.kioskChart) {
                chartInstances.kioskChart.destroy();
            }

            // Generate subtle blue tones for pie chart
            const colors = ['#2196f3', '#1976d2', '#1565c0', '#0d47a1', '#0039a6', '#2196f3', '#1976d2', '#1565c0'];

            chartInstances.kioskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: colors.slice(0, data.labels.length),
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 11 }, color: '#666', padding: 15 }
                        }
                    }
                }
            });
        }

        // Daily Trends Functions
        function loadDailyTrends() {
            fetch(`${ANALYTICS_API}/api/analytics/aggregated`)
                .then(response => response.json())
                .then(data => {
                    // Process daily data for line charts
                    const dates = data.daily.map(d => d.date);
                    const volumes = data.daily.map(d => d.total_volume_ml);
                    const transactions = data.daily.map(d => d.total_transactions);

                    createDailyVolumeChart({
                        display_dates: dates,
                        volumes: volumes
                    });

                    createDailyTransactionsChart({
                        display_dates: dates,
                        transactions: transactions
                    });

                    // Process weekday data
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    const weekdayVolumes = dayNames.map(day => {
                        return data.by_day_of_week[day] ? data.by_day_of_week[day].total_volume_ml : 0;
                    });

                    createWeekdayTrendsChart({
                        days: dayNames,
                        volumes: weekdayVolumes
                    });
                })
                .catch(error => {
                    console.error('Error loading aggregated trends:', error);
                    document.getElementById('analytics-footer').textContent = 'Error loading aggregated data';
                });
        }

        function createDailyVolumeChart(data) {
            const ctx = document.getElementById('chart-daily-volume').getContext('2d');

            if (chartInstances.dailyVolumeChart) {
                chartInstances.dailyVolumeChart.destroy();
            }

            chartInstances.dailyVolumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.display_dates,
                    datasets: [{
                        label: 'Volume (L)',
                        data: data.volumes,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#2196f3',
                        pointBorderColor: '#1976d2',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    return 'Volume: ' + (value / 1000).toFixed(2) + ' L';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function createDailyTransactionsChart(data) {
            const ctx = document.getElementById('chart-daily-transactions').getContext('2d');

            if (chartInstances.dailyTransactionsChart) {
                chartInstances.dailyTransactionsChart.destroy();
            }

            chartInstances.dailyTransactionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.display_dates,
                    datasets: [{
                        label: 'Transaction Count',
                        data: data.transactions,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#2196f3',
                        pointBorderColor: '#1976d2',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function createWeekdayTrendsChart(data) {
            const ctx = document.getElementById('chart-weekday-trends').getContext('2d');

            if (chartInstances.weekdayTrendsChart) {
                chartInstances.weekdayTrendsChart.destroy();
            }

            chartInstances.weekdayTrendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.days,
                    datasets: [{
                        label: 'Total Volume (L)',
                        data: data.volumes,
                        backgroundColor: [
                            '#2196f3',
                            '#2196f3',
                            '#2196f3',
                            '#2196f3',
                            '#2196f3',
                            '#1976d2',
                            '#1976d2'
                        ],
                        borderColor: '#1565c0',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 11 }, color: '#666' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    return 'Volume: ' + (value / 1000).toFixed(2) + ' L';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return (value / 1000).toFixed(1) + ' L';
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#888', font: { size: 10 } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
